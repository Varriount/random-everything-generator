<style>
  div.reg-title {
      border-bottom: 1px solid #000;
  }
  .reg-select {
    margin-right: 5px;
    float: left;
  }
  .reg-select select {
    min-height: 150px;
    max-height: 250px;
  }
  .reg-tables {
    float:left;
    max-width: 600px;
    max-height: 250px;
    overflow-y: auto;
  }
  .reg-tables-name {
    vertical-align: top;
  }
  .reg-tables-value {
    display: inline-block;
    max-width: 300px;
    vertical-align: top;
  }
  .reg-name {
    font-weight: bold;
    text-decoration: underline;
  }
</style>

<form>
  <div class="reg-title"><b>What would you like to create?</b></div>
    <div style="flexcol" id="reg-row">
      <section id="col0" class="reg-select">
      </section>
      <section id="col1" class="reg-select">
        <select multiple id='select1' onChange="populateCategory(this)">
          {{#each categories}}
            <option value="{{id}}">{{name}}</option>
          {{/each}}
        </select>
      </section>
    </div>
  </div>
</form>

<script type="text/javascript">
  const xml = `{{{xml}}}`;
  const parser = new DOMParser();
  const doc = parser.parseFromString(xml, 'application/xml');
  let markovJSON = '';
  loadMarkov();

  function loadMarkov() {
    let xhr = new XMLHttpRequest();
    xhr.open('GET', '/modules/random-everything-generator/markov-source/male-names.markov');
    xhr.onload = function() {
      const jsonStr = xhr.response;
      markovJSON = JSON.parse(jsonStr);
    }
    xhr.send();
  }

  function getNextLetter(prev) {
    // Get a capital letter to start
    let nxt = markovJSON[prev];
    let total = 0
    Object.keys(nxt).forEach(letter => total += nxt[letter])
    let rnd = Math.floor(Math.random() * total);
    let r = '';
    let i = 0;
    Object.keys(nxt).every(letter => {
      i += parseInt(nxt[letter]);
      if (i > rnd) {
        r += letter;
        return false;
      }
      return true;
    });
    return r;
  }

  function fromMarkov() {
    if (markovJSON == '')
      return "Unknown";
    let r = '';   
    r = getNextLetter('');
    while (r.length < 3 || r.substr(r.length-2) != '--') {
      r += getNextLetter(r.substr(r.length-1))
    }
    r = r.substr(0, r.length-2);
    return r;
  }

  /*
   * Generates a name from a <table type="name">
   *
   * Arguments: [XMLNode] <table type="name"> node
   * Returns:   [String]  generated name
   */
  function generateName(node) {
    const nodePatterns = node.getElementsByTagName("patterns");
    if (nodePatterns.length == 0)
      return;
    const nodePattern = nodePatterns[0].getElementsByTagName("pattern");
    let htmlValue = '';
    for (const pattern of nodePattern) {
      let p = pattern.textContent;
      let m = p.match(/\{(.*?)\}/);
      while (m && m.length > 0) {
        const listType = m[1];
        switch (listType) {
          case 'markov': {
            p = p.replace('{markov}', fromMarkov);
            break;
          }
          default: {
            let values = []
            const nodesList = node.getElementsByTagName("list");
            for (let i = 0; i < nodesList.length; i++) {
              if (nodesList[i].getAttribute("type") == listType) {
                let items = nodesList[i].getElementsByTagName("item");
                for (let j = 0; j < items.length; j++) {
                  values.push(items[j].textContent);
                }
              }
            }
            let r = values[Math.floor(Math.random()*values.length)];
            p = p.replace('{'+m[1]+'}', r);
            break;
          }
        }
        m = p.match(/\{(.*?)\}/);
      }
      htmlValue = p;
    }
    return htmlValue
  }

  function createElement(tag, value=null) {
    const elem = document.createElement(tag)
    elem.id = 'id_' + Math.floor(Math.random()*1000000);
    if (value != null)
      elem.innerHTML = value
    return elem;
  }

  function createRegenButton(callback = ()=>{}) {
    const aRegen = document.createElement('A');
    aRegen.addEventListener('click', callback);
    const iRegen = document.createElement('I');
    $(iRegen).addClass('fas fa-sync-alt');
    $(iRegen).css({'display': 'inline-block', 'margin-left': '5px'})
    aRegen.appendChild(iRegen);
    return aRegen;
  }

  function buildFromTable(node, regenAllButton) {
    if (node.getAttribute("include")) return; // These shouldn't exist anymore

    let div = document.createElement('DIV');
    const tableName = node.getAttribute("name");
    const tableId = node.getAttribute("id");
    const tableType = node.getAttribute("type") || "standard";
    switch (tableType) {
      case "standard": {
        const nodeValues = node.getElementsByTagName("value");
        let randValue = Math.floor(Math.random() * nodeValues.length);
        const spanName = createElement('SPAN', tableName+' '); 
        $(spanName).addClass('reg-tables-name')
        div.appendChild(spanName)
        const spanValue = createElement('SPAN', nodeValues[randValue].textContent)
        $(spanValue).addClass('reg-tables-value')
        div.appendChild(spanValue);
        let regenFunction = () => {
          let randValue = Math.floor(Math.random() * nodeValues.length);
          spanValue.innerHTML = nodeValues[randValue].textContent;
        }
        div.appendChild(createRegenButton(regenFunction));
        regenAllButton.addEventListener('click', regenFunction)
        break;
      }
      case "pattern":
      case "name": {
        $(div).addClass('reg-name');
        div.appendChild(createElement('SPAN', 'Name: '));

        const spanValue = createElement('SPAN', generateName(node));
        div.appendChild(spanValue);
        let regenFunction = () => spanValue.innerHTML = generateName(node);
        div.appendChild(createRegenButton(regenFunction));
        regenAllButton.addEventListener('click', regenFunction);
      }
    }
    return div;
  }

  function buildFromInclude(node, rDiv) {
    let include = node.getAttribute('include');
    $.get('/modules/random-everything-generator/xml/'+include+'.xml', data => {
      const table = data.getElementsByTagName('table')[0];
      const values = table.getElementsByTagName('value');
      const value = values[Math.floor(Math.random() * values.length)];
      document.getElementById(rDiv).innerHTML = value.textContent;
    });
  }

  function populateCategory(select) {
    const selectedValue = select.value;
    const id = selectedValue;
    let colIdx = select.parentNode.id.substr(3);

    // Check if the category is in the Categories XML
    const category = doc.getElementById(id);
    if (category.children.length > 0) { // This category has child nodes
      colIdxNext = parseInt(colIdx) + 1;
      let sectionNext = document.createElement('SECTION');
      sectionNext.id = "col"+colIdxNext;
      sectionNext.classList.add('reg-select');
      selectNext = document.createElement('SELECT');
      selectNext.id = 'select' + colIdx;
      selectNext.multiple = true;      
      selectNext.style.height = (category.children.length*1.3)+'em';
      selectNext.addEventListener('change', function() {
        populateCategory(this);
      })
      sectionNext.appendChild(selectNext);

      for (const child of category.children) {
        let option = document.createElement('OPTION');
        option.value = child.getAttribute('id');
        option.innerHTML = child.getAttribute('name');
        selectNext.appendChild(option);
      }

      if (document.getElementById('col'+colIdxNext)) {
        $(`section#col${colIdxNext}`).replaceWith(sectionNext)
      } else {
        document.getElementById('reg-row').appendChild(sectionNext);
      }
    } else { // Load and generate random tables
      // Reduce previous column to col0
      /*
      let prevColIdx = colIdx - 1;
      if (!document.getElementById('archived_col' + prevColIdx)) {
        let prevSelect = document.getElementById('select'+prevColIdx);
        prevSelectedValue = prevSelect.options[prevSelect.selectedIndex].innerHTML;
        let divListItem = createElement('DIV', prevSelectedValue);
        divListItem.id = 'archived_col' + prevColIdx;
        divListItem.addEventListener('click', () => {
          let idx = divListItem.id.substr(12)
          console.log(idx);
          let i = idx;
          while (document.getElementById('col'+(++i))) {
            document.getElementById('col'+i).remove();
          }
        })
        document.getElementById('col0').appendChild(divListItem);
        document.getElementById('col' + prevColIdx).style.display = 'none';
      }
      */

      // Create Result section
      let sectionNext = document.createElement('SECTION');
      sectionNext.classList.add('reg-tables');
      sectionNext.id = 'col'+(colIdxNext+1);
      //console.log(sectionNext.id);
      document.getElementById('reg-row').appendChild(sectionNext);

      let xhr = new XMLHttpRequest();
      xhr.open('GET', '/modules/random-everything-generator/xml/'+id+'.xml');
      xhr.send();
      xhr.onload = function() {
        const xmlStr = xhr.response;
        const parser = new DOMParser();
        const doc = parser.parseFromString(xmlStr, 'application/xml');
        const nodeCategory = doc.getElementsByTagName('category')[0];
        const catTitle = nodeCategory.getAttribute("name");
        const nodeName = nodeCategory.getElementsByTagName('name')[0];
        if (nodeName) {
          const name = nodeName.getAttribute('name');
        }

        let div = document.getElementById('col'+(colIdxNext+1));
        div.innerHTML = '';

        // TODO: 
        // Load in <member> tags
        const h2 = document.createElement('H2');
        const regenAllButton = createRegenButton()
        h2.innerHTML = catTitle;
        h2.appendChild(regenAllButton)
        div.appendChild(h2);

        if (nodeName) {
          const divName = document.createElement('DIV');
          divName.appendChild(createElement('SPAN', 'Name: '));
          let spanValue = createElement('SPAN', fromMarkov());
          divName.appendChild(spanValue);
          let regenFunction = () => spanValue.innerHTML = fromMarkov();
          divName.appendChild(createRegenButton(regenFunction));
          regenAllButton.addEventListener('click', regenFunction)
          div.appendChild(divName);
        }

        for (const categoryChild of nodeCategory.children) {
          switch(categoryChild.tagName) {
            case 'table': {
              div.appendChild(buildFromTable(categoryChild, regenAllButton));
              break;
            }
            case 'include': {
              let rDiv = document.createElement('DIV');
              let spanName = createElement('SPAN', categoryChild.getAttribute('name') + ': ');
              let spanValue = createElement('SPAN');
              rDiv.appendChild(spanName);
              rDiv.appendChild(spanValue);
              div.appendChild(rDiv);
              let regenFunction = () => buildFromInclude(categoryChild, spanValue.id);
              buildFromInclude(categoryChild, spanValue.id);
              rDiv.appendChild(createRegenButton(regenFunction));
              regenAllButton.addEventListener('click', regenFunction)
              break;
            }
          }
        }
      }
    }
  }
</script>

